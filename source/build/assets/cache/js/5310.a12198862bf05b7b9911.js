"use strict";(self.webpackJsonpDeezer=self.webpackJsonpDeezer||[]).push([[5310],{zuHY:(e,t,n)=>{n.d(t,{MG:()=>m,NP:()=>u,ny:()=>b,VF:()=>L}),Error,Error;class o extends Error{constructor(e){super(e),this.name="UnloggedError"}}class r extends Error{constructor(e){super(e),this.name="JWTRenewError"}}class s extends Error{constructor(e){super(e),this.name="JWTFetchError"}}class i extends Error{constructor(e){super(e),this.name="JWTCacheError"}}let h=function(e){return e.ANONYMOUS="ANONYMOUS",e.ARL="ARL",e.CREDENTIALS="CREDENTIALS",e.LOGOUT="LOGOUT",e.PARTNER="PARTNER",e.RENEW="RENEW",e}({});const a={ANONYMOUS:"login/anonymous",ARL:"login/arl",CREDENTIALS:"login/credentials",LOGOUT:"logout",PARTNER:"login/partner-access-token",RENEW:"login/renew"};let u=function(e){return e.COOKIE="c",e.PAYLOAD="p",e}({});var c=n("/0+J"),l=n("MVPB"),p=n("4OMY"),d=(0,p.A)("refreshToken");const f=class{constructor(){Object.defineProperty(this,d,{writable:!0,value:void 0}),(0,l.A)(this,d)[d]=null}get(){return(0,l.A)(this,d)[d]}set(e){if("string"!=typeof e)throw new Error(`Token is invalid. String expected, got ${typeof e}.`);(0,l.A)(this,d)[d]=e}invalidate(){(0,l.A)(this,d)[d]=null}};class T extends Error{}function y(){return Math.round(Date.now()/1e3)}T.prototype.name="InvalidTokenError";var O=(0,p.A)("token"),A=(0,p.A)("approximateClientExpire"),w=(0,p.A)("requestDelay");const v=class{constructor(e,t){Object.defineProperty(this,O,{writable:!0,value:null}),Object.defineProperty(this,A,{writable:!0,value:0}),Object.defineProperty(this,w,{writable:!0,value:void 0}),(0,l.A)(this,w)[w]=t,e&&this.set(e)}get(){return(0,l.A)(this,O)[O]}set(e){if("string"!=typeof e)throw new Error(`Token is invalid. String expected, got ${typeof e}.`);let t;try{t=function(e,t){if("string"!=typeof e)throw new T("Invalid token specified: must be a string");t||(t={});const n=!0===t.header?0:1,o=e.split(".")[n];if("string"!=typeof o)throw new T(`Invalid token specified: missing part #${n+1}`);let r;try{r=function(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return function(e){return decodeURIComponent(atob(e).replace(/(.)/g,((e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(t)}catch(e){return atob(t)}}(o)}catch(e){throw new T(`Invalid token specified: invalid base64 for part #${n+1} (${e.message})`)}try{return JSON.parse(r)}catch(e){throw new T(`Invalid token specified: invalid json for part #${n+1} (${e.message})`)}}(e)}catch(e){throw new Error("Could not decode JWT")}const{exp:n,iat:o}=t;if("number"!=typeof n||"number"!=typeof o)throw new Error("JWT does not contain any value for issuedAt or expire");const r=y()-o;(0,l.A)(this,A)[A]=n+r,(0,l.A)(this,O)[O]=e}isExpired(){return y()>(0,l.A)(this,A)[A]-(0,l.A)(this,w)[w]}isValid(){return null!==(0,l.A)(this,O)[O]&&!this.isExpired()}invalidate(){(0,l.A)(this,O)[O]=null,(0,l.A)(this,A)[A]=0}},C=({host:e,authType:t,inputType:n,tokenOutputType:o,refreshTokenOutputType:r})=>{const s=new URL(`https://${e}/${a[t]}`),i={jo:o,rto:r};let h;for(h in n&&(i.i=n),i){const e=i[h];void 0!==e&&s.searchParams.append(h,e)}return s.href};var E=(0,p.A)("refreshToken");function g(){return R.apply(this,arguments)}function R(){return(R=(0,c.A)((function*(){var e;const t=null==(e=this.refreshTokenCache)?void 0:e.get();let n,s=u.COOKIE,i="include";t&&(s=u.PAYLOAD,n=JSON.stringify({refresh_token:t}),i="omit");const a=C({host:this.host,authType:h.RENEW,inputType:s,tokenOutputType:this.tokenOutputType,refreshTokenOutputType:this.refreshTokenOutputType}),c=yield this.fetch.call(null,a,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:n,credentials:i}).catch((()=>{throw new r("Could not fetch JWT Token")}));if(!c.ok)throw new o("Could not fetch JWT Token");if(this.fetchShouldHaveReponse){var l,p;const{jwt:e,refresh_token:t}=yield c.json();null==(l=this.tokenCache)||l.set(e),null==(p=this.refreshTokenCache)||p.set(t)}return null}))).apply(this,arguments)}const m=class{get fetchShouldHaveReponse(){return this.tokenOutputType===u.PAYLOAD||this.refreshTokenOutputType===u.PAYLOAD}constructor({host:e,customFetch:t=globalThis.fetch,requestDelay:n=15,tokenOutputType:o=u.PAYLOAD,refreshTokenOutputType:r=u.COOKIE,refreshTokenCache:s}){Object.defineProperty(this,E,{value:g}),this.host=void 0,this.fetch=void 0,this.requestDelay=void 0,this.tokenOutputType=void 0,this.refreshTokenOutputType=void 0,this.tokenCache=null,this.refreshTokenCache=null,this.host=e,this.fetch=t,this.requestDelay=n,this.tokenOutputType=o,this.refreshTokenOutputType=r,this.tokenOutputType===u.PAYLOAD&&(this.tokenCache=new v(null,this.requestDelay)),this.refreshTokenOutputType===u.PAYLOAD&&(this.refreshTokenCache=s||new f)}getToken(){var e=this;return(0,c.A)((function*(){var t;if(null!=(t=e.tokenCache)&&t.isValid())return e.tokenCache.get();if(yield(0,l.A)(e,E)[E](),e.tokenCache&&e.tokenCache.get()){if(e.tokenCache.isValid())return e.tokenCache.get();throw new i("Could not fetch valid JWT Token")}return null}))()}invalidateCurrentToken(){var e,t;null==(e=this.tokenCache)||e.invalidate(),null==(t=this.refreshTokenCache)||t.invalidate()}logout(){var e=this;return(0,c.A)((function*(){e.invalidateCurrentToken();const t=`https://${e.host}/${a.LOGOUT}`;yield e.fetch.call(null,t,{method:"GET",credentials:"include"}).catch((()=>{throw new Error("Could not invalidate current tokens")}))}))()}},b=function(e){return class extends e{loginAsAnonymous(){var e=this;return(0,c.A)((function*(){const t=C({host:e.host,authType:h.ANONYMOUS,tokenOutputType:e.tokenOutputType,refreshTokenOutputType:e.refreshTokenOutputType}),n=yield e.fetch.call(null,t,{method:"GET",headers:{Accept:"application/json"}}).catch((()=>{throw new s("Could not fetch anonymous JWT Token")}));if(!n.ok)throw new o(`Could not log in as anonymous. Got error ${n.status}`);if(e.fetchShouldHaveReponse){var r;const{jwt:t}=yield n.json().catch((()=>{throw new s("Response does not contain a valid JWT Token")}));return null==(r=e.tokenCache)||r.set(t),t}return null}))()}}},L=function(e){return class extends e{loginWithArl(e,t){var n=this;return(0,c.A)((function*(){let r;e&&(r={arl:e,account_id:t});const i=C({host:n.host,authType:h.ARL,inputType:void 0!==r?u.PAYLOAD:u.COOKIE,tokenOutputType:n.tokenOutputType,refreshTokenOutputType:n.refreshTokenOutputType}),a=void 0!==r?{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)}:{method:"POST",headers:{Accept:"application/json"},credentials:"include"},c=yield n.fetch.call(null,i,a).catch((()=>{throw new s("Could not fetch JWT Token with ARL")}));if(!c.ok)throw new o(`Could not fetch JWT Token with ARL. Got error ${c.status}`);if(n.fetchShouldHaveReponse){var l,p;const{jwt:e,refresh_token:t}=yield c.json().catch((()=>{throw new s("Response does not contain valid tokens")}));return null==(l=n.refreshTokenCache)||l.set(t),null==(p=n.tokenCache)||p.set(e),e}return null}))()}}}}}]);